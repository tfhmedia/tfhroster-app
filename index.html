<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roster Gen | Dark Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#030712',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* Dark Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 5px; border: 2px solid #1f2937; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        dialog::backdrop { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }

        .assignment-wrapper { transition: all 0.2s; }
        .assignment-wrapper.dragging { opacity: 0.5; transform: scale(0.98); border: 1px dashed #6366f1; }
        .assignment-wrapper.drag-over { background-color: #374151; border-radius: 0.5rem; box-shadow: 0 0 0 2px #6366f1; }
        
        .roster-cell { transition: background-color 0.2s; }
        .roster-cell.drag-over-cell { background-color: #1f2937; box-shadow: inset 0 0 0 2px #818cf8; }
        
        .role-row.drag-over-row { box-shadow: inset 0 2px 0 0 #818cf8; }
        
        .swapped { animation: highlight 1s ease-out; }
        @keyframes highlight { 0% { background-color: #312e81; } 100% { background-color: transparent; } }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
        .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }

        /* Custom Input styling for dark mode */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

    <div id="app" class="p-4 md:p-8 max-w-[1600px] mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-8 border-b border-gray-800 pb-6">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">Roster Gen</h1>
                <p class="text-gray-400 mt-2 text-sm">Smart scheduling for modern teams.</p>
            </div>
            
            <div class="flex flex-wrap gap-3">
                 <!-- Undo/Redo Group -->
                 <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-700">
                     <button id="undo-button" class="px-3 py-2 text-gray-300 hover:text-white hover:bg-gray-700 rounded-md disabled:opacity-30 disabled:cursor-not-allowed transition-colors" title="Undo (Ctrl+Z)" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
                    </button>
                     <button id="redo-button" class="px-3 py-2 text-gray-300 hover:text-white hover:bg-gray-700 rounded-md disabled:opacity-30 disabled:cursor-not-allowed transition-colors" title="Redo (Ctrl+Y)" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/></svg>
                    </button>
                 </div>

                 <!-- File Operations -->
                 <div class="flex gap-2">
                     <button id="save-session-button" class="px-4 py-2 bg-gray-800 border border-gray-700 text-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-700 hover:text-white hover:border-gray-600 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Save
                    </button>
                    <label for="load-session-input" class="cursor-pointer px-4 py-2 bg-gray-800 border border-gray-700 text-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-700 hover:text-white hover:border-gray-600 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Load
                        <input type="file" id="load-session-input" class="hidden" accept=".json">
                    </label>
                 </div>

                 <!-- Actions -->
                <button id="team-modal-button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-lg shadow-indigo-900/50 text-sm font-semibold hover:bg-indigo-500 transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Team
                </button>
                <button id="generate-roster-button" class="px-4 py-2 bg-emerald-600 text-white rounded-lg shadow-lg shadow-emerald-900/50 text-sm font-semibold hover:bg-emerald-500 transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
                    Generate
                </button>
                 <button id="download-pdf-button" class="px-3 py-2 bg-gray-800 text-gray-400 hover:text-white rounded-lg hover:bg-gray-700 transition-colors" title="Export PDF">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                </button>
                 <button id="clear-roster-button" class="px-3 py-2 bg-gray-800 text-red-400 hover:text-red-300 rounded-lg hover:bg-gray-700 transition-colors" title="Clear All">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                </button>
            </div>
        </header>

        <!-- Controls Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
            
            <!-- Roles Card -->
            <div class="bg-gray-900 border border-gray-800 p-5 rounded-2xl shadow-xl shadow-gray-950/50">
                 <h3 class="font-semibold text-gray-300 flex items-center gap-2 mb-4">
                     <span class="p-1.5 bg-indigo-500/10 text-indigo-400 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                     </span>
                    Add Role
                 </h3>
                <form id="add-role-form" class="flex gap-2">
                    <input type="text" id="role-name-input" placeholder="e.g. Audio Engineer..." class="flex-grow bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-500 transition-all">
                    <button type="submit" class="p-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </form>
                
                <div class="mt-4 flex items-center justify-between bg-gray-800/50 p-3 rounded-lg border border-gray-800">
                    <span class="text-sm text-gray-400">Allow Same Day Duplicates</span>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="allow-duplicates-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 border-gray-800 appearance-none cursor-pointer top-0.5 left-0.5 transition-all"/>
                        <label for="allow-duplicates-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                    </div>
                </div>
            </div>
            
            <!-- Dates Card -->
            <div class="bg-gray-900 border border-gray-800 p-5 rounded-2xl shadow-xl shadow-gray-950/50">
                <h3 class="font-semibold text-gray-300 flex items-center gap-2 mb-4">
                    <span class="p-1.5 bg-emerald-500/10 text-emerald-400 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </span>
                     Add Date
                </h3>
                <form id="add-date-form" class="flex flex-col gap-3">
                    <input type="date" id="date-input" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 placeholder-gray-500 transition-all" required>
                    <div class="flex gap-2">
                        <input type="text" id="event-name-input" placeholder="Event (e.g. Youth Night)" class="flex-grow bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 placeholder-gray-500 transition-all">
                        <button type="submit" class="p-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg transition-colors aspect-square flex items-center justify-center">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Quick Actions / Unavailability -->
            <div class="bg-gray-900 border border-gray-800 p-5 rounded-2xl shadow-xl shadow-gray-950/50 flex flex-col justify-between">
                 <h3 class="font-semibold text-gray-300 flex items-center gap-2 mb-4">
                    <span class="p-1.5 bg-amber-500/10 text-amber-400 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                    </span>
                     Manage Unavailability
                </h3>
                <p class="text-xs text-gray-500 mb-4">Mark dates where specific members cannot be rostered. This prevents scheduling conflicts.</p>
                <button id="unavailability-modal-button" class="w-full py-2.5 bg-gray-800 border border-gray-700 text-amber-500 hover:text-amber-400 hover:border-amber-500/50 rounded-lg text-sm font-semibold transition-all flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    Open Calendar
                </button>
            </div>
        </div>

        <!-- Volunteer Schedule Lookup -->
        <div id="volunteer-lookup-section" class="bg-gray-900 border border-gray-800 p-5 rounded-2xl shadow-xl shadow-gray-950/50 mb-8 hidden">
            <h3 class="font-semibold text-gray-300 mb-3 text-sm uppercase tracking-wider">Volunteer Schedule Lookup</h3>
            <div class="flex flex-col md:flex-row gap-4">
                <div class="w-full md:w-1/3">
                    <select id="volunteer-select" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">-- Select Team Member --</option>
                    </select>
                </div>
                <div id="volunteer-assignments-display" class="flex-grow flex flex-wrap gap-2 text-sm text-gray-400 items-center">
                    <!-- Assignments will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Roster Table Area -->
        <main class="bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl shadow-gray-950/50 overflow-hidden min-h-[400px]">
            <div id="roster-table-container" class="w-full overflow-x-auto">
                <!-- Table generated here -->
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Unavailability Modal -->
    <dialog id="unavailability-modal" class="p-0 bg-gray-900 rounded-xl shadow-2xl max-w-md w-[95%] text-gray-100 border border-gray-800">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Set Unavailability</h2>
                <button id="unavailability-cancel-btn-top" class="text-gray-500 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            
            <div class="mb-6">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Team Member</label>
                <select id="unavailability-member-select" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">Select a member...</option>
                </select>
            </div>

            <!-- Calendar -->
            <div id="calendar-container" class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <button id="prev-month-btn" class="p-1 hover:bg-gray-700 rounded text-gray-400 hover:text-white">&lt;</button>
                    <h3 id="calendar-month-year" class="font-semibold text-sm"></h3>
                    <button id="next-month-btn" class="p-1 hover:bg-gray-700 rounded text-gray-400 hover:text-white">&gt;</button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm"></div>
            </div>

            <div class="mt-6">
                 <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Selected Dates</h4>
                 <div id="calendar-selected-dates" class="flex flex-wrap gap-2 min-h-[2.5rem]"></div>
            </div>

            <div class="flex justify-end gap-3 mt-8">
                <button id="unavailability-cancel-btn" class="px-4 py-2 bg-gray-800 border border-gray-700 text-gray-300 rounded-lg text-sm font-medium hover:bg-gray-700">Cancel</button>
                <button id="unavailability-save-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-500 shadow-lg shadow-indigo-900/50">Save Changes</button>
            </div>
        </div>
    </dialog>

    <!-- Team Modal -->
    <dialog id="team-modal" class="p-0 bg-gray-900 rounded-xl shadow-2xl max-w-4xl w-[95%] text-gray-100 border border-gray-800 h-[85vh]">
        <div class="flex flex-col h-full">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-gray-900">
                <div>
                    <h2 class="text-2xl font-bold">Team Management</h2>
                    <p class="text-gray-500 text-sm">Add members, define roles, and import data.</p>
                </div>
                <button id="close-modal-button" class="text-gray-500 hover:text-white p-2 rounded-full hover:bg-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>

            <!-- Modal Content (Scrollable) -->
            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                
                <!-- Section: Manage Roles -->
                <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-5">
                    <h3 class="text-lg font-semibold mb-4 text-indigo-400">Manage Roles</h3>
                    <form id="modal-add-role-form" class="flex gap-2 mb-4">
                        <input type="text" id="modal-role-name-input" placeholder="New role name..." class="flex-grow bg-gray-900 border border-gray-700 text-white rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" class="px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500 text-sm font-medium">Add</button>
                    </form>
                    <div id="modal-roles-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-48 overflow-y-auto pr-2"></div>
                </div>

                <!-- Section: Add Member -->
                <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-5">
                    <h3 class="text-lg font-semibold mb-4 text-emerald-400">Add / Edit Member</h3>
                    <form id="add-member-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Name</label>
                                <input type="text" id="member-name" class="w-full bg-gray-900 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Availability Note</label>
                                <input type="text" id="member-availability" placeholder="e.g. Weekends only" class="w-full bg-gray-900 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-medium text-gray-400 mb-2">Roles Capable Of</label>
                                <div id="roles-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 bg-gray-900 p-3 rounded-lg border border-gray-700"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-medium text-gray-400 mb-1">Internal Notes</label>
                                <input type="text" id="member-notes" placeholder="Skills, preferences..." class="w-full bg-gray-900 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 pt-2 border-t border-gray-700">
                            <button type="button" id="cancel-edit-button" class="px-4 py-2 text-gray-400 hover:text-white text-sm hidden">Cancel</button>
                            <button type="submit" class="px-6 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-500 shadow-lg shadow-emerald-900/50">Save Member</button>
                        </div>
                    </form>
                </div>

                <!-- Section: CSV Import -->
                <div class="bg-gray-800/30 border border-gray-700 rounded-xl p-5 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div>
                        <h3 class="font-semibold text-gray-300">Import CSV</h3>
                        <p class="text-xs text-gray-500">Format: name,roles(semicolon sep),availability,notes</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="download-template-button" class="px-3 py-2 bg-gray-900 border border-gray-700 text-gray-400 rounded-lg text-xs hover:text-white hover:border-gray-500">Template</button>
                        <label class="px-3 py-2 bg-gray-700 text-white rounded-lg text-xs cursor-pointer hover:bg-gray-600">
                            Upload File
                            <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                        </label>
                    </div>
                </div>

                <!-- Section: Member List -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-300" id="team-members-heading">Team List</h3>
                        <button id="clear-all-members-button" class="text-xs text-red-400 hover:text-red-300 hover:underline">Clear All</button>
                    </div>
                    <div id="team-members-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <p id="no-members-message" class="text-center text-gray-600 py-8 hidden">No members yet.</p>
                </div>
            </div>
        </div>
    </dialog>

    <div id="notification-area" class="fixed top-5 right-5 z-[60] flex flex-col gap-2"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- State ---
            let state = {
                roles: [
                    { name: 'Main Camera', isMultiple: false, count: 1 },
                    { name: 'Second Camera', isMultiple: false, count: 1 },
                    { name: 'ProPresenter', isMultiple: false, count: 1 },
                    { name: 'Live Monitoring', isMultiple: false, count: 1 },
                ],
                dates: [],
                teamMembers: [],
                roster: {},
                unavailability: {},
                settings: { allowDuplicates: false }
            };
            let history = [];
            let historyIndex = -1;
            let calendarState = { year: new Date().getFullYear(), month: new Date().getMonth(), selectedDates: new Set() };
            let selectedMemberForCalendar = null;
            let dragSrcItem = null;
            let draggedRoleRow = null;
            const MAX_HISTORY = 20;

            // --- DOM Elements ---
            const els = {
                rosterTable: document.getElementById('roster-table-container'),
                teamModal: document.getElementById('team-modal'),
                unavailabilityModal: document.getElementById('unavailability-modal'),
                rolesCheckboxes: document.getElementById('roles-checkboxes'),
                teamList: document.getElementById('team-members-list'),
                volunteerSelect: document.getElementById('volunteer-select'),
                volunteerDisplay: document.getElementById('volunteer-assignments-display'),
                memberForm: document.getElementById('add-member-form'),
                cancelEditBtn: document.getElementById('cancel-edit-button'),
                rolesListModal: document.getElementById('modal-roles-list'),
                unavMemberSelect: document.getElementById('unavailability-member-select'),
                calGrid: document.getElementById('calendar-grid'),
                calDates: document.getElementById('calendar-selected-dates'),
                calTitle: document.getElementById('calendar-month-year'),
                notifyArea: document.getElementById('notification-area')
            };

            // --- Helper Functions ---
            const showNotification = (message, isError = false) => {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.className = `px-4 py-3 rounded-lg shadow-lg text-white text-sm font-medium transition-all duration-300 transform translate-x-10 opacity-0 ${isError ? 'bg-red-600' : 'bg-emerald-600'}`;
                els.notifyArea.appendChild(notification);
                
                requestAnimationFrame(() => {
                    notification.classList.remove('translate-x-10', 'opacity-0');
                });

                setTimeout(() => {
                    notification.classList.add('opacity-0', 'translate-x-10');
                    notification.addEventListener('transitionend', () => notification.remove());
                }, 3000);
            };

            const saveState = () => localStorage.setItem('rosterAppState', JSON.stringify(state));

            const pushToHistory = () => {
                if (historyIndex < history.length - 1) history = history.slice(0, historyIndex + 1);
                history.push(JSON.parse(JSON.stringify(state.roster)));
                if (history.length > MAX_HISTORY) history.shift();
                historyIndex = history.length - 1;
                updateUndoRedoButtons();
            };

            const updateUndoRedoButtons = () => {
                const undoBtn = document.getElementById('undo-button');
                const redoBtn = document.getElementById('redo-button');
                if(undoBtn) undoBtn.disabled = historyIndex <= 0;
                if(redoBtn) redoBtn.disabled = historyIndex >= history.length - 1;
            };

            // --- RENDER LOGIC ---
            const renderRosterTable = () => {
                if (state.dates.length === 0 || state.roles.length === 0) {
                    els.rosterTable.innerHTML = `<div class="p-12 text-center text-gray-500 bg-gray-800/50 rounded-xl border border-gray-800 border-dashed"><p>Roster is empty. Start by adding roles and dates.</p></div>`;
                    return;
                }
                const sortedDates = [...state.dates].sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Table Construction
                let html = `<table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b border-gray-800">
                            <th class="p-4 font-semibold text-gray-400 text-xs uppercase tracking-wider bg-gray-900 sticky left-0 z-20 w-48 shadow-[4px_0_12px_-4px_rgba(0,0,0,0.5)]">Role</th>`;
                
                sortedDates.forEach(d => {
                    const pU = state.teamMembers.filter(m => m.unavailableDates.includes(d.date)).map(m => m.name);
                    const gU = state.unavailability[d.date] || [];
                    const uCount = new Set([...pU, ...gU]).size;
                    const dateObj = new Date(d.date+'T00:00:00');
                    
                    html += `<th class="p-4 min-w-[200px] border-l border-gray-800 group relative" data-date-header="${d.date}" data-event-header="${d.event}">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-gray-200 text-sm">${dateObj.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div>
                                <div class="font-medium text-gray-500 text-xs mt-0.5">${d.event || dateObj.toLocaleDateString('en-US',{weekday:'short'})}</div>
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button data-generate-for-date="${d.date}" class="p-1.5 text-gray-500 hover:text-emerald-400 hover:bg-emerald-400/10 rounded" title="Generate this column">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                                </button>
                                <button data-date-to-delete="${d.date}" class="p-1.5 text-gray-500 hover:text-red-400 hover:bg-red-400/10 rounded" title="Delete column">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </div>
                        ${uCount>0 ? `<div class="absolute bottom-1 right-2 text-[10px] text-amber-500 bg-amber-500/10 px-1.5 py-0.5 rounded border border-amber-500/20">${uCount} unav</div>` : ''}
                    </th>`;
                });
                html += `</tr></thead><tbody>`;
                
                state.roles.forEach(role => {
                    html += `<tr class="role-row bg-gray-900 border-b border-gray-800 hover:bg-gray-800/30 group" data-role-row="${role.name}">
                        <th class="p-4 text-gray-300 font-medium text-sm sticky left-0 bg-gray-900 group-hover:bg-gray-800/30 z-20 w-48 shadow-[4px_0_12px_-4px_rgba(0,0,0,0.5)] cursor-grab active:cursor-grabbing border-r border-gray-800" draggable="true">
                            <div class="flex justify-between items-center">
                                <span>${role.name} ${role.isMultiple?`<span class="text-xs text-gray-500 ml-1">(${role.count})</span>`:''}</span>
                                <button data-role-to-delete="${role.name}" class="p-1 text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                </button>
                            </div>
                        </th>`;
                    
                    sortedDates.forEach(d => {
                        const date = d.date;
                        let assigned = state.roster[date]?.[role.name] || [];
                        const dU = state.unavailability[date] || [];
                        
                        // Populate Dropdown Options
                        const availableMembers = state.teamMembers.filter(member => 
                            member.roles.includes(role.name) && 
                            !member.unavailableDates.includes(date) &&
                            !dU.includes(member.name)
                        );
                        
                        let assignedElsewhere = [];
                        if (!state.settings.allowDuplicates) {
                            Object.keys(state.roster[date] || {}).forEach(rName => {
                                if (rName !== role.name) assignedElsewhere = assignedElsewhere.concat(state.roster[date][rName]);
                            });
                        }

                        const dropdownMembers = [...new Set([...availableMembers.map(m => m.name), ...assigned])].sort();
                        const allM = state.teamMembers.map(m=>m.name);
                        
                        if(assigned.length === 0) assigned=[''];
                        
                        html += `<td class="roster-cell p-3 border-l border-gray-800 align-top min-w-[200px]" data-role="${role.name}" data-date="${date}">`;
                        
                        assigned.forEach((mem, idx) => {
                            const isU = state.teamMembers.some(m => m.name===mem && (m.unavailableDates.includes(date) || dU.includes(mem)));
                            const isC = mem && !allM.includes(mem);
                            
                            // Improved Styling for Inputs/Selects
                            let baseClasses = "w-full py-2 pl-3 pr-10 text-sm border rounded-lg shadow-sm appearance-none cursor-pointer transition-colors focus:ring-2 focus:ring-indigo-500/50 outline-none";
                            let normalClasses = "bg-gray-800 border-gray-700 text-white hover:border-gray-600";
                            let errorClasses = "bg-red-900/20 border-red-800/50 text-red-200";
                            
                            let cls = `${baseClasses} ${isU ? errorClasses : normalClasses}`;
                            let inputCls = `${baseClasses} bg-gray-800 border-indigo-500/50 text-white`;
                            
                            if (isC) cls += " hidden";
                            
                            html += `
                            <div class="assignment-wrapper relative mb-2 group/item" draggable="true" data-role="${role.name}" data-date="${date}" data-index="${idx}">
                                <select class="${cls} roster-assignment-select" data-role="${role.name}" data-date="${date}" data-index="${idx}">
                                    <option value="" class="text-gray-500">-- Select --</option>
                                    ${dropdownMembers.map(n => {
                                        let disabled = '';
                                        let label = n;
                                        if (assignedElsewhere.includes(n) && mem !== n) { disabled = 'disabled'; label += ' (Busy)'; }
                                        return `<option value="${n}" ${mem===n?'selected':''} ${disabled}>${label}${isU&&mem===n?' (Unav)':''}</option>`;
                                    }).join('')}
                                    <option value="__custom_input__" class="font-semibold text-indigo-400">+ Custom Name...</option>
                                </select>
                                
                                <input type="text" value="${isC?mem:''}" class="custom-name-input ${isC?'block':'hidden'} ${inputCls} absolute top-0 left-0 z-10" data-role="${role.name}" data-date="${date}" data-index="${idx}" placeholder="Type name..."/>
                                
                                <div class="absolute inset-y-0 right-1 flex items-center pointer-events-none text-gray-500">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>

                                <button type="button" data-role="${role.name}" data-date="${date}" data-index="${idx}" 
                                    class="absolute inset-y-0 right-1 my-auto h-6 w-6 flex items-center justify-center text-gray-500 hover:text-red-400 bg-gray-800 hover:bg-gray-700 rounded z-20 remove-assignment-btn transition-colors shadow-sm border border-gray-700 hover:border-gray-600" 
                                    title="Clear">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                </button>
                            </div>`;
                        });
                        
                        html += `<button type="button" class="add-assignment-btn w-full py-1.5 text-xs text-gray-500 border border-gray-700 border-dashed rounded hover:bg-gray-800 hover:text-indigo-400 hover:border-indigo-500/50 transition-all opacity-50 hover:opacity-100" data-role="${role.name}" data-date="${date}">+ Add Slot</button>`;
                        html += `</td>`;
                    });
                    html += `</tr>`;
                });
                
                html += `</tbody></table>`;
                els.rosterTable.innerHTML = html;
                attachRosterEventListeners();
            };

            const renderRolesCheckboxes = () => {
                if (state.roles.length > 0) {
                    els.rolesCheckboxes.innerHTML = state.roles.map(role => `
                        <label class="flex items-center space-x-3 p-3 bg-gray-800 rounded-lg border border-gray-700 hover:border-gray-600 cursor-pointer transition-colors">
                            <input type="checkbox" name="roles" value="${role.name}" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500/50 bg-gray-700">
                            <span class="text-sm text-gray-300 select-none">${role.name}</span>
                        </label>`).join('');
                } else {
                    els.rolesCheckboxes.innerHTML = `<p class="text-gray-500 col-span-full text-sm italic">Define roles in the main dashboard first.</p>`;
                }
            };

            const renderTeamMembers = () => {
                if(state.teamMembers.length === 0) {
                    document.getElementById('no-members-message').classList.remove('hidden');
                    els.teamList.innerHTML = '';
                } else {
                    document.getElementById('no-members-message').classList.add('hidden');
                    els.teamList.innerHTML = state.teamMembers.map(member => `
                        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 hover:border-gray-600 transition-colors group relative">
                            <div class="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button data-member-id-edit="${member.id}" class="p-1.5 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></button>
                                <button data-member-id-delete="${member.id}" class="p-1.5 text-gray-400 hover:text-red-400 hover:bg-gray-700 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            </div>
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm">
                                    ${member.name.substring(0,2).toUpperCase()}
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-200">${member.name}</h4>
                                    <p class="text-xs text-gray-500">${member.availability || 'Availability not set'}</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-1.5 mb-3">
                                ${member.roles.map(r => `<span class="text-[10px] font-medium bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full border border-gray-600">${r}</span>`).join('')}
                            </div>
                            ${member.unavailableDates.length > 0 ? 
                                `<div class="pt-3 border-t border-gray-700/50">
                                    <p class="text-[10px] uppercase font-bold text-amber-500 mb-1">Unavailable</p>
                                    <div class="flex flex-wrap gap-1">
                                        ${member.unavailableDates.map(d => `<span class="text-[10px] bg-amber-500/10 text-amber-400 px-1.5 py-0.5 rounded border border-amber-500/20">${new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>`).join('')}
                                    </div>
                                </div>` : ''}
                        </div>`).join('');
                }
                document.getElementById('team-members-heading').textContent = `Team List (${state.teamMembers.length})`;
            };

            const renderModalRolesList = () => {
                els.rolesListModal.innerHTML = state.roles.length === 0 ? `<p class="text-sm text-gray-500 italic">No roles added yet.</p>` : state.roles.map(role => `
                    <div class="bg-gray-900 border border-gray-700 p-3 rounded-lg flex flex-col gap-2">
                        <div class="flex items-center gap-2">
                            <input type="text" value="${role.name}" data-original-role-name="${role.name}" class="modal-role-input flex-grow bg-transparent text-sm font-medium text-white focus:outline-none border-b border-transparent focus:border-indigo-500 px-1">
                            <button data-role-to-delete="${role.name}" class="text-gray-500 hover:text-red-400 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                        </div>
                        <div class="flex items-center gap-4 text-xs text-gray-400">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" data-role-multiple-toggle="${role.name}" ${role.isMultiple ? 'checked' : ''} class="rounded bg-gray-700 border-gray-600 text-indigo-500 focus:ring-indigo-500/50"> Allow Multiple
                            </label>
                            <div class="${role.isMultiple ? 'flex items-center gap-2' : 'hidden'}">
                                <span>Max:</span>
                                <select data-role-count-select="${role.name}" class="bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-white focus:outline-none">
                                    <option value="1" ${role.count==1?'selected':''}>1</option>
                                    <option value="2" ${role.count==2?'selected':''}>2</option>
                                    <option value="3" ${role.count==3?'selected':''}>3</option>
                                    <option value="4" ${role.count==4?'selected':''}>4</option>
                                    <option value="5" ${role.count==5?'selected':''}>5</option>
                                </select>
                            </div>
                        </div>
                    </div>`).join('');
            };

            const populateDropdowns = () => {
                const sM = [...state.teamMembers].sort((a,b) => a.name.localeCompare(b.name));
                const opts = '<option value="">-- Select --</option>' + sM.map(m=>`<option value="${m.name}">${m.name}</option>`).join('');
                els.volunteerSelect.innerHTML = opts;
                els.unavMemberSelect.innerHTML = opts;
            };

            const renderCalendar = () => {
                const year = calendarState.year;
                const month = calendarState.month;
                els.calTitle.textContent = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                els.calGrid.innerHTML = '';
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => els.calGrid.innerHTML += `<div class="font-bold text-gray-500 text-xs py-2">${day}</div>`);
                for (let i = 0; i < firstDay; i++) els.calGrid.innerHTML += `<div></div>`;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isSel = calendarState.selectedDates.has(dStr);
                    const todayStr = new Date().toISOString().slice(0,10);
                    const isToday = dStr === todayStr;
                    
                    els.calGrid.innerHTML += `
                        <button class="calendar-day aspect-square rounded-full flex items-center justify-center text-sm transition-all
                        ${isSel ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50' : 'text-gray-300 hover:bg-gray-700'} 
                        ${isToday && !isSel ? 'border border-indigo-500 text-indigo-400' : ''}" 
                        data-date="${dStr}">${day}</button>`;
                }
                
                els.calDates.innerHTML = [...calendarState.selectedDates].sort().map(d => `
                    <span class="flex items-center gap-1.5 text-xs font-medium bg-gray-800 text-indigo-300 px-2 py-1 rounded-full border border-gray-700">
                        ${new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}
                        <button type="button" data-deselect-date="${d}" class="hover:text-white transition-colors">&times;</button>
                    </span>`).join('') || `<span class="text-xs text-gray-600 italic px-1">No dates selected</span>`;
            };

            const generateForDate = (date) => {
                if (!state.roster[date]) state.roster[date] = {};
                const dU = state.unavailability[date] || [];
                const dayAssign = {}; 
                state.roles.forEach(role => {
                    const avail = state.teamMembers.filter(m => m.roles.includes(role.name) && !m.unavailableDates.includes(date) && !dU.includes(m.name) && (state.settings.allowDuplicates || !dayAssign[m.name]));
                    let shuff = [...avail].sort(() => 0.5 - Math.random());
                    let toAssign = [];
                    for(let i=0; i<role.count && i<shuff.length; i++) {
                        toAssign.push(shuff[i].name);
                        if (!state.settings.allowDuplicates) dayAssign[shuff[i].name] = true;
                    }
                    state.roster[date][role.name] = toAssign;
                });
                pushToHistory(); updateState(state);
            };

            const loadState = () => {
                const s = localStorage.getItem('rosterAppState');
                if(s) { state = JSON.parse(s); }
                // Init missing properties
                if(!state.unavailability) state.unavailability = {};
                state.teamMembers.forEach(m => { if(!m.unavailableDates) m.unavailableDates = []; });
                state.roles = state.roles.map(r => typeof r === 'string' ? { name: r, isMultiple: false, count: 1 } : r);
                history = [JSON.parse(JSON.stringify(state.roster))];
                historyIndex = 0;
            };

            const renderAll = () => {
                renderRosterTable();
                renderRolesCheckboxes();
                renderTeamMembers();
                renderModalRolesList();
                populateDropdowns();
                document.getElementById('allow-duplicates-toggle').checked = state.settings.allowDuplicates;
            };

            const updateState = (newState) => {
                state = newState;
                saveState();
                renderAll();
            };

            // --- Handlers & Listeners ---
            const handleAssignmentChange = (e) => {
                const select = e.target;
                const roleName = select.dataset.role, date = select.dataset.date, index = parseInt(select.dataset.index);
                const selectedValue = select.value;
                const parentDiv = select.closest('.assignment-wrapper');
                const customInput = parentDiv.querySelector('.custom-name-input');
                
                if (!state.roster[date]) state.roster[date] = {};
                let assignments = state.roster[date][roleName] || [];
                state.roster[date][roleName] = assignments;

                if (selectedValue === '__custom_input__') {
                    customInput.classList.remove('hidden'); customInput.focus(); select.classList.add('hidden');
                    return; 
                } 
                customInput.classList.add('hidden'); select.classList.remove('hidden');
                
                if (index === 0 && selectedValue === '' && assignments.length === 1) state.roster[date][roleName] = [''];
                else if (selectedValue === '') state.roster[date][roleName].splice(index, 1);
                else state.roster[date][roleName][index] = selectedValue;

                if (state.roster[date][roleName].length > 1) state.roster[date][roleName] = state.roster[date][roleName].filter(n => n !== '');
                
                pushToHistory(); updateState(state);
            };

            const handleCustomNameBlur = (e) => {
                const input = e.target;
                const roleName = input.dataset.role, date = input.dataset.date, index = parseInt(input.dataset.index);
                const customName = input.value.trim();
                if (!state.roster[date]) state.roster[date] = {};
                let assignments = state.roster[date][roleName] || [];
                state.roster[date][roleName] = assignments;
                state.roster[date][roleName][index] = customName || '';
                if (state.roster[date][roleName].length > 1) state.roster[date][roleName] = state.roster[date][roleName].filter(name => name !== '');
                
                pushToHistory(); updateState(state);
            };

            const handleRemoveAssignment = (e) => {
                const btn = e.target.closest('button');
                const roleName = btn.dataset.role, date = btn.dataset.date, index = parseInt(btn.dataset.index);
                let assignments = state.roster[date]?.[roleName] || [''];
                if (assignments.length > 1) assignments.splice(index, 1);
                else assignments[0] = '';
                if (!state.roster[date]) state.roster[date] = {};
                state.roster[date][roleName] = assignments;
                pushToHistory(); updateState(state);
            };

            const handleAddAssignment = (e) => {
                const btn = e.target.closest('button');
                const roleName = btn.dataset.role, date = btn.dataset.date;
                if (!state.roster[date]) state.roster[date] = {};
                if (!state.roster[date][roleName]) state.roster[date][roleName] = [''];
                state.roster[date][roleName].push('');
                pushToHistory(); updateState(state);
            };

            // D&D Handlers
            const handleItemDragStart = (e) => { e.stopPropagation(); dragSrcItem = e.target; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; };
            const handleItemDragEnd = (e) => { if(dragSrcItem) dragSrcItem.classList.remove('dragging'); dragSrcItem = null; document.querySelectorAll('.drag-over-cell').forEach(el => el.classList.remove('drag-over-cell')); };
            const handleCellDragOver = (e) => { if (dragSrcItem) { e.preventDefault(); e.currentTarget.classList.add('drag-over-cell'); } };
            const handleCellDragLeave = (e) => { e.currentTarget.classList.remove('drag-over-cell'); };
            const handleCellDrop = (e) => {
                if (dragSrcItem) {
                    e.preventDefault(); e.stopPropagation();
                    const destCell = e.currentTarget; destCell.classList.remove('drag-over-cell');
                    const srcDate = dragSrcItem.dataset.date, srcRole = dragSrcItem.dataset.role, srcIndex = parseInt(dragSrcItem.dataset.index);
                    const destDate = destCell.dataset.date, destRole = destCell.dataset.role;
                    
                    if (srcDate === destDate && srcRole === destRole) return;
                    const srcVal = state.roster[srcDate][srcRole][srcIndex];
                    if(!srcVal) return;

                    // Swap or Move logic here (simplified for space)
                    state.roster[srcDate][srcRole].splice(srcIndex, 1);
                    if(state.roster[srcDate][srcRole].length === 0) state.roster[srcDate][srcRole] = [''];
                    if (!state.roster[destDate]) state.roster[destDate] = {};
                    if (!state.roster[destDate][destRole]) state.roster[destDate][destRole] = [];
                    state.roster[destDate][destRole].push(srcVal);
                    if(state.roster[destDate][destRole].length > 1) state.roster[destDate][destRole] = state.roster[destDate][destRole].filter(n => n !== '');
                    
                    pushToHistory(); updateState(state);
                }
            };

            const attachRosterEventListeners = () => {
                document.querySelectorAll('.roster-assignment-select').forEach(el => el.addEventListener('change', handleAssignmentChange));
                document.querySelectorAll('.custom-name-input').forEach(el => el.addEventListener('blur', handleCustomNameBlur));
                document.querySelectorAll('.remove-assignment-btn').forEach(el => el.addEventListener('click', handleRemoveAssignment));
                document.querySelectorAll('.add-assignment-btn').forEach(el => el.addEventListener('click', handleAddAssignment));
                document.querySelectorAll('.assignment-wrapper').forEach(el => { el.addEventListener('dragstart', handleItemDragStart); el.addEventListener('dragend', handleItemDragEnd); });
                document.querySelectorAll('.roster-cell').forEach(el => { el.addEventListener('dragover', handleCellDragOver); el.addEventListener('dragleave', handleCellDragLeave); el.addEventListener('drop', handleCellDrop); });
            };

            // Listeners
            document.getElementById('add-role-form').addEventListener('submit', e => { e.preventDefault(); const v = document.getElementById('role-name-input').value.trim(); if(v && !state.roles.some(r=>r.name===v)) { state.roles.push({name:v, isMultiple:false, count:1}); document.getElementById('role-name-input').value=''; updateState(state); }});
            document.getElementById('add-date-form').addEventListener('submit', e => { e.preventDefault(); const d = document.getElementById('date-input').value; const ev = document.getElementById('event-name-input').value.trim(); if(d && !state.dates.some(dt=>dt.date===d)) { state.dates.push({date:d, event:ev}); document.getElementById('date-input').value=''; document.getElementById('event-name-input').value=''; updateState(state); }});
            document.getElementById('generate-roster-button').addEventListener('click', () => { state.dates.forEach(d=>generateForDate(d.date)); });
            document.getElementById('clear-roster-button').addEventListener('click', () => { if(confirm("Clear Roster?")) { state.roster={}; pushToHistory(); updateState(state); }});
            document.getElementById('save-session-button').addEventListener('click', () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(state)], {type:'application/json'})); a.download = 'roster.json'; a.click(); });
            document.getElementById('load-session-input').addEventListener('change', e => { const r=new FileReader(); r.onload=x=>{state=JSON.parse(x.target.result); loadState(); updateState(state);}; if(e.target.files[0]) r.readAsText(e.target.files[0]); });
            
            // Modal Toggles
            document.getElementById('team-modal-button').addEventListener('click', () => els.teamModal.showModal());
            document.getElementById('close-modal-button').addEventListener('click', () => els.teamModal.close());
            document.getElementById('unavailability-modal-button').addEventListener('click', () => { selectedMemberForCalendar=null; els.unavMemberSelect.value=''; calendarState.selectedDates.clear(); renderCalendar(); els.unavailabilityModal.showModal(); });
            document.getElementById('unavailability-cancel-btn').addEventListener('click', () => els.unavailabilityModal.close());
            document.getElementById('unavailability-cancel-btn-top').addEventListener('click', () => els.unavailabilityModal.close());
            
            // Unavailability Logic
            document.getElementById('unavailability-save-btn').addEventListener('click', () => { 
                if(!selectedMemberForCalendar) return; 
                const m=state.teamMembers.find(x=>x.name===selectedMemberForCalendar); 
                if(m){ m.unavailableDates=[...calendarState.selectedDates].sort(); updateState(state); } 
                els.unavailabilityModal.close(); 
            });
            els.unavMemberSelect.addEventListener('change', e => { selectedMemberForCalendar=e.target.value; calendarState.selectedDates.clear(); if(selectedMemberForCalendar){ const m=state.teamMembers.find(x=>x.name===selectedMemberForCalendar); if(m) m.unavailableDates.forEach(d=>calendarState.selectedDates.add(d)); } renderCalendar(); });
            document.getElementById('prev-month-btn').addEventListener('click', () => { calendarState.month--; if(calendarState.month<0){calendarState.month=11;calendarState.year--;} renderCalendar(); });
            document.getElementById('next-month-btn').addEventListener('click', () => { calendarState.month++; if(calendarState.month>11){calendarState.month=0;calendarState.year++;} renderCalendar(); });
            els.calGrid.addEventListener('click', e => { if(e.target.classList.contains('calendar-day')){ const d=e.target.dataset.date; if(calendarState.selectedDates.has(d)) calendarState.selectedDates.delete(d); else calendarState.selectedDates.add(d); renderCalendar(); } });
            els.calDates.addEventListener('click', e => { const btn=e.target.closest('[data-deselect-date]'); if(btn){ calendarState.selectedDates.delete(btn.dataset.deselectDate); renderCalendar(); } });

            // Table Interactions
            els.rosterTable.addEventListener('click', e => {
                const gen = e.target.closest('[data-generate-for-date]'); if(gen) generateForDate(gen.dataset.generateForDate);
                const del = e.target.closest('[data-date-to-delete]'); if(del) { state.dates=state.dates.filter(d=>d.date!==del.dataset.dateToDelete); delete state.roster[del.dataset.dateToDelete]; updateState(state); }
                const delR = e.target.closest('[data-role-to-delete]'); if(delR) { const r=delR.dataset.roleToDelete; state.roles=state.roles.filter(x=>x.name!==r); Object.keys(state.roster).forEach(d=>delete state.roster[d][r]); updateState(state); }
            });

            // Member Form
            els.memberForm.addEventListener('submit', e => { 
                e.preventDefault(); 
                const n=document.getElementById('member-name').value.trim(); 
                const roles=[...document.querySelectorAll('input[name="roles"]:checked')].map(c=>c.value); 
                if(n){ 
                    state.teamMembers.push({id:Date.now(), name:n, roles:roles, availability:document.getElementById('member-availability').value, notes:document.getElementById('member-notes').value, unavailableDates:[]});
                    els.memberForm.reset(); 
                    updateState(state); 
                }
            });
            els.teamList.addEventListener('click', e => {
                const del=e.target.closest('[data-member-id-delete]'); if(del){ state.teamMembers=state.teamMembers.filter(x=>x.id!==parseFloat(del.dataset.memberIdDelete)); updateState(state); }
            });
            
            // Initialization
            loadState();
            renderAll();
            updateUndoRedoButtons();
        });
    </script>
</body>
</html>
